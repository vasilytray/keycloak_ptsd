# Keycloak с Let's Encrypt с использованием Docker Compose
Это форк from heyvaldemar/keycloak-traefik-letsencrypt-docker-compose

## Комплексное решение для развертывания Keycloak на VPS с использованием Docker Compose, Traefik, PostgreSQL и SSL

[Keycloak](https://www.keycloak.org/) — программное обеспечение с открытым исходным кодом, обеспечивающее единый вход, идентификацию и управление доступом для современных приложений и сервисов.

> [!tip] Примечание
> Мы будем использовать [Traefik](https://traefik.io/traefik/) в качестве обратного прокси-сервера. Он будет получать криптографические сертификаты от [Let's Encrypt](https://letsencrypt.org/) для ваших доменных имён и направлять запросы к соответствующим сервисам на основе этих доменов.

>[!note] Важно!
>На сервере должны быть установлены Docker Engine и Docker Compose.
Документация по установке Docker Engine на Ubuntu Server см. в статье [Установка Docker Engine и Docker Compose на Ubuntu Server.](https://docs.docker.com/engine/install/ubuntu/#installation-methods)

1. Клонируйте репозиторий на сервер.

```sh
git clone git@github.com:vasilytray/keycloak_ptsd.git
```

2. Перейдите в каталог с репозиторием

```sh
cd keycloak_ptsd
```

3. Измените переменные 
сделайте копию `env.tmp` в `.env` и откройте для редактирования переменных в соответствии с вашими требованиями.

- `TRAEFIK_ACME_EMAIL` - укажите свой email для Let\`s Encrypt
- `TRAEFIK_HOSTNAME` - укажите Ваш публичный домен(поддомен) для доступа к панели Traefik, связанный c IP адресом (нужна A-запись у регистратора)
- `TRAEFIK_BASIC_AUTH=traefikadmin:$$2y$$10$$sMzJfirKC75x/hVpiINeZOiSm.Jkity9cn4KwNkRvO7hSQVFc5FLO` - Аутентификация для Traefik, где traefikadmin - это username, а `$$2y$$10$$sMzJfirKC75x/hVpiINeZOiSm.Jkity9cn4KwNkRvO7hSQVFc5FLO` - это Пароль который должен быть закодирован используя MD5, SHA1 или BCrypt.

>[!danger] Внимание!
>При получении хэша BCrypt необходимо все знаки $ экранировать - поставить рядом с каждым еще один знак $


>[!note] Можно воспользоваться одним из он-лайн сервисов:
> например [Bcrypt Hash Generator](https://bcrypt-generator.com/)

- `KEYCLOAK_DB_NAME - имя базы данных для Keycloak,
- `KEYCLOAK_DB_USER`- пользователь БД
- `KEYCLOAK_DB_PASSWORD` - пароль доступа к базе
- `KEYCLOAK_ADMIN_USERNAME` - пользователь с правами админа для доступа в Keycloak,
- `KEYCLOAK_ADMIN_PASSWORD` - пароль админа для доступа в Keycloak,
- `KEYCLOAK_HOSTNAME`- укажите Ваш публичный домен(поддомен) для доступа к панели Keycloak, связанный c IP адресом (нужна A-запись у регистратора)

>[!tip] Обратите внимание, что `.env`файл должен находиться в том же каталоге, что и `docker-compose.yml`.


Развертывание Keycloak с помощью Docker Compose:

`docker compose -f docker-compose.yml -p keycloak up -d`

## Резервные копии

Контейнер `backups`в конфигурации отвечает за следующее:

1. **Резервное копирование базы данных** : создает сжатые резервные копии базы данных PostgreSQL с помощью pg_dump. Путь к резервной копии, шаблон имени файла и расписание можно настраивать с помощью переменных, таких как `POSTGRES_BACKUPS_PATH`, `POSTGRES_BACKUP_NAME`, и `BACKUP_INTERVAL`.
    
2. **Очистка резервных копий** : периодически удаляет резервные копии, превышающие указанный возраст, для управления хранилищем. Настраиваемый график очистки и порог возраста можно настроить с помощью `KEYCLOAK_POSTGRES_BACKUP_PRUNE_DAYS`

Использование этого контейнера обеспечивает согласованное и автоматизированное резервное копирование основных компонентов вашего экземпляра. Более того, эффективное управление хранилищем резервных копий и настраиваемые процедуры резервного копирования могут быть достигнуты благодаря простой и гибкой настройке с использованием переменных среды.

## Описание keycloak-restore-database.sh

Этот скрипт облегчает восстановление резервной копии базы данных:

1. **Идентификация контейнеров** : сначала идентифицирует службу и создает резервные копии контейнеров по имени, находя соответствующие идентификаторы контейнеров.
    
2. **Список резервных копий** : отображает все доступные резервные копии базы данных, расположенные по указанному пути резервного копирования.
    
3. **Выбрать резервную копию** : предлагает пользователю скопировать и вставить нужное имя резервной копии из списка для восстановления базы данных.
    
4. **Остановка службы** : Временно останавливает службу, чтобы обеспечить целостность данных во время восстановления.
    
5. **Восстановление базы данных** : выполняет последовательность команд для удаления текущей базы данных, создания новой и ее восстановления из выбранного сжатого файла резервной копии.
    
6. **Запустить службу** : перезапускает службу после завершения восстановления.
    

Чтобы сделать `keycloak-restore-database.shh`скрипт исполняемым, выполните следующую команду:

`chmod +x keycloak-restore-database.sh`

Использование этого скрипта обеспечивает контролируемый и управляемый процесс восстановления базы данных из существующей резервной копии.

[![нижний колонтитул](https://user-images.githubusercontent.com/10498744/210157572-1fca0242-8af2-46a6-bfa3-666ffd40ebde.svg)]
